<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../assets/font/fontawesome/css/all.css">
    <link rel="stylesheet" href="../assets/font/themify-icons/themify-icons.css">
    <link
    rel="apple-touch-icon-precomposed"
    sizes="144x144"
    href="img/ico/apple-touch-icon-144-precomposed.png"
  />

  <link rel="stylesheet" href="../assets/css/grid.css">
  <link rel="stylesheet" href="../assets/css/base.css">
  <link rel="stylesheet" href="../assets/css/main.css">
  <link rel="stylesheet" href="../assets/css/responsive.css">
  
</head>
<body>
    <div id="purchase">
        <div class="header">
            <div class="header-top">
                <div class="grid">
                    <div class="header-top-content">
                        <ul class="contact-list">
                            <li class="contact-item">
                                <a href="" class="contact-item__link">
                                    <i class="fa fa-phone"></i>
                                    <span class="contact-item__info">+2 95 01 88 821</span>
                                </a>
                            </li>
                            <li class="contact-item">
                                <a href="" class="contact-item__link">
                                    <i class="fa fa-envelope"></i>
                                    <span class="contact-item__info"> info@domain.com</span>
                                </a>
                            </li>
                        </ul>
                        <ul class="socials">
                            <li class="social">
                                <a href="#" class="social-link">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="#" class="social-link">
                                    <i class="fab fa-twitter"></i>
                                </a>
                                <a href="#" class="social-link">
                                    <i class="fab fa-linkedin"></i>
                                </a>
                                <a href="#" class="social-link">
                                    <i class="fab fa-dribbble"></i>
                                </a>
                                <a href="#" class="social-link">
                                    <i class="fab fa-google-plus"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="header-middle">
                <div class="grid header-middle-content">
                    <div class="menu-left">
                        <div class="header-logo">
                            <a href="header-logo__link">
                                <img  class='header-logo__img' src="./assets/img/home/logo.png" alt="">
                            </a>
                        </div>
                        <div class="header-buttons">
                            <div class="header-btn-group" onclick="dropDown(event)">
                                <div class="header-btn">
                                    <span class="header-btn__name">USA</span>
                                    <i class="fas fa-caret-down"></i>
                                </div>
                                <div class="sub-menu">
                                    <ul>
                                        <li>
                                            <a href="">Canada Dollar</a>
                                        </li>
                                        <li>
                                            <a href="">Collar</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="header-btn-group">
                                <div class="header-btn" onclick="dropDown(event)">
                                    <span class="header-btn__name">DOLLAR</span>
                                    <i class="fas fa-caret-down"></i>
                                </div>   
                                <div class="sub-menu" >
                                    <ul>
                                        <li>
                                            <a href="">Canada Dollar</a>
                                        </li>
                                        <li>
                                            <a href="">Uk</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="menu-right">
                        <nav class="header-nav">
                            <ul class="header-menu">
                                <li class="header-menu-item">
                                    <a href="" class="header-menu-item__link">
                                        <i class="fa fa-user"></i>
                                        Account
                                    </a>
                                </li>
                                <li class="header-menu-item">
                                    <a href="" class="header-menu-item__link">
                                        <i class="fa fa-star"></i>
                                        Wishlist
                                    </a>
                                </li>
                                <li class="header-menu-item">
                                    <a href="" class="header-menu-item__link">
                                        <i class="fa fa-crosshairs"></i>
                                        Checkout
                                    </a>
                                </li>
                                <li class="header-menu-item">
                                    <a href="" class="header-menu-item__link">
                                        <i class="fa fa-shopping-cart"></i>
                                        Cart
                                    </a>
                                </li>
                                <li class="header-menu-item">
                                    <a href="" class="header-menu-item__link">
                                        <i class="fa fa-lock"></i>
                                        Login
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
            <div class="header-bottom">
                <div class="grid header-bottom-content">
                    <div class="header-main-menu">
                        <nav class="header-nav">
                            <ul class="header-menu">
                                <li class="header-menu-item active">
                                    <a href="" class="header-menu-item__link">
                                        Home
                                    </a>
                                </li>
                                <li class="header-menu-item">
                                    <a href="" class="header-menu-item__link">
                                        Shop
                                        <i class="fas fa-caret-down"></i>
                                    </a>
                                    <ul class="sub-menu">
                                        <li>
                                            <a href="">Sản phẩm</a>
                                        </li>
                                        <li>
                                            <a href="">Chi tiết sản phầm</a>
                                        </li>
                                        <li>
                                            <a href="">Mua hàng</a>
                                        </li>
                                        <li>
                                            <a href="">Giỏ hàng</a>
                                        </li>
                                        <li>
                                            <a href="">Giỏ hàng</a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="header-menu-item">
                                    <a href="" class="header-menu-item__link">
                                        Block
                                        <i class="fas fa-caret-down"></i>
                                    </a>
                                    <ul class="sub-menu">
                                        <li>
                                            <a href="">Sản phẩm</a>
                                        </li>
                                        <li>
                                            <a href="">Chi tiết sản phầm</a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="header-menu-item">
                                    <a href="" class="header-menu-item__link">
                                        404
                                    </a>
                                </li>
                                <li class="header-menu-item">
                                    <a href="" class="header-menu-item__link">
                                        Contact
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                    <div class="header-search">
                        <div class="header-search__input-group">
                            <input type="text" placeholder="Search">
                        </div>
                        <div class="header-search__btn">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main">
            <div class="grid">
                <div class="row">
                    <div class="col l-2">
                        <div class="menu-left">
                            <div class="profile">
                                <div class="profile-img-wrap">
                                    <div class="profile-img"></div>
                                </div>
                                <div class="profile-name-wrap">
                                    <p class="profile-name">nguyen dang duc</p>
                                    <a href="" class="profile-edit">
                                        <span class="ti-pencil"></span>
                                        Sửa hồ sơ
                                    </a>
                                </div>
                            </div>
                            <ul class="menu-left__list">
                                <li class="menu-left__item">
                                    <a href="#" class="menu-left__link">
                                        <i class="far fa-user"></i>
                                        <span>Tài khoản của tôi</span>
                                    </a>
                                </li>
                                <li class="menu-left__item">
                                    <a href="#" class="menu-left__link">
                                        <i class="far fa-calendar-minus"></i>
                                        <span>Đơn mua</span>
                                    </a>
                                </li>
                                <li class="menu-left__item">
                                    <a href="#" class="menu-left__link">
                                        <i class="far fa-bell"></i>
                                        <span>Thông báo</span>
                                    </a>
                                </li>
                                <li class="menu-left__item">
                                    <a href="#" class="menu-left__link">
                                        <i class="fas fa-wallet"></i>
                                        <span>Ví Voucher</span>
                                    </a>
                                </li>
                                <li class="menu-left__item">
                                    <a href="#" class="menu-left__link">
                                        <i class="fas fa-dollar-sign"></i>
                                        <span>Shop xu</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col l-10">
                        <div class="menu-right">
                            <div class="nav">
                                <div class="nav__list row no-gutter">
                                    <div onclick="getPurchase(event,0)" class="nav__item col l-2 selected">Tất cả</div>
                                    <div onclick="getPurchase(event,1)" class="nav__item col l-2">Chờ xác nhận</div>
                                    <div onclick="getPurchase(event,2)" class="nav__item col l-2">Chờ lấy hàng</div>
                                    <div onclick="getPurchase(event,3)" class="nav__item col l-2">Đang giao</div>
                                    <div onclick="getPurchase(event,4)" class="nav__item col l-2">Đã giao</div>
                                    <div onclick="getPurchase(event,5)" class="nav__item col l-2">Đã hủy</div>
                                </div>
                                
                            </div>
                            <div class="search-box">
                                <div class="input-group">
                                    <input type="text" placeholder="Tìm kiếm theo Tên Shop,ID đơn hàng hoặc Tên sản phẩm">
                                </div>
                                <span onclick="search(event)" class="ti-search"></span>
                            </div>
                            <div class="purchased-order">
                                <ul class="list-order">
                                    <li class="order">
                                        
                                        
                                    </li>
                                    
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script src="../assets/js/plugins/js/sweetalert.min.js"></script>
    <script src="../assets/js/plugins/axios/dist/axios.min.js"></script>
    <script>
        const api = 'http://localhost:3000'
        const orderDiv = document.querySelector('.purchased-order .list-order')
        const orderCtr = document.querySelector('.order-ctl-other')
        let purchase = null
        async function getPurchase(event,param) {
            if(event) {//load event undefined, change css
                let oldOption = event.target.parentNode.querySelector('.selected')
                let valUpdate = oldOption.getAttribute("class").replace("selected","")//remove class
                oldOption.setAttribute('class',valUpdate)

                let classList =  event.target.getAttribute('class')
                classList += ` selected`//add class
                event.target.setAttribute('class',classList)
            }
            
            let purchaseData = null
            if(param === 0) {
                purchaseData = await axios.get(`${api}/purchase`)
                purchase = purchaseData.data
            } else if(param === 1) {
                purchaseData = await axios.get(`${api}/purchase/?state=1`)
                purchase = purchaseData.data      
            } else if(param === 2) {
                purchaseData = await axios.get(`${api}/purchase/?state=2`)
                purchase = purchaseData.data
            } else if(param === 3) {
                purchaseData = await axios.get(`${api}/purchase/?state=3`)
                purchase = purchaseData.data
            } else if(param === 4) {
                purchaseData = await axios.get(`${api}/purchase/?state=4`)
                purchase = purchaseData.data
            } else if(param === 5) {
                purchaseData = await axios.get(`${api}/purchase/?state=5`)
                purchase = purchaseData.data
            }
            
            if(purchase.length === 0) {
                orderDiv.innerHTML = '<p style="text-align:center;font-size:1.4rem">Chưa có đơn hàng</p>'
            }
            let x = ''
            purchase.forEach( async o => {// 1 purchase bao gom nhieu order
                let state = o.state
                let products = o.products // cac sp trong 1 lan order
                let totalInOneOrder = 0
                let y = ''
                for(let key in products) {
                    let productData = await axios.get(`${api}/productAll/${key}`)
                    let product = productData.data
                    let categoryData = await axios.get(`${api}/category/${product.category}`)
                    let category = categoryData.data
                    totalInOneOrder += Number(product.price.slice(1))*Number(products[key].quantity)
                    y+= `
                    <div class="product-item">
                        <div class="row">
                            <div class="col l-2">
                                <img src=${product.image} alt="" class="product-img">
                            </div>
                            <div class="col l-10">
                                <div class="product-info">
                                    <div class="product-info-wrap">
                                        <p class="product-info__name">${product.name}</p>
                                        <p class="product-info__cate">Phân loại thú cưng: ${category.name}</p>
                                        <span class="product-info__quantity">x ${products[key].quantity}</span>
                                    </div>
                                    <div class="product-info__price">
                                        <span class="current-price">${product.price}</span>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    `
                    
                }
                x += `
                    <li class="order">
                        <div class="product-items">${y}</div>
                            <div class="product-ctl-other">
                                <div class="product-middle">
                                    <div class="product-total">
                                        <span>Tổng số tiền:</span>
                                        <span class="product-total__price">$${totalInOneOrder}</span>
                                    </div>
                                </div>
                                <div class="product-bottom">
                                    <span class="product-state">${state===1 ? 'Chờ xác nhận': state===2 ? 'Chờ lấy hàng' : state===3 ? 'Đang giao' : state===4 ? 'Đã giao' : state === 5 ? 'Đã hủy' : '' }</span>
                                    <div class="product-ctr">
                                        <button class="btn product-ctr__btn-cancel" onclick='cancelOrder(event,"${state}","${o.id}")'>Hủy đơn hàng</button>
                                        <button class="btn product-ctr__btn-detail">Chi tiết hủy đơn</button>
                                    </div>
                                </div>
                            </div>   
                    </li>
                `
                orderDiv.innerHTML = x
            });
        }
        getPurchase(event,0)
        async function cancelOrder(event,state,id) {
            if(state == "1") {
                let check = await swal("Bạn có muốn hủy đơn hàng này", {
                buttons: ["Oh noez!", true],
                });
                if(check) {
                    let currentOrder = await axios.get(`${api}/purchase/${id}`)
                    let updateOrder = {...currentOrder.data,state:5}
                    delete updateOrder.id

                    let data = await axios.put(`${api}/purchase/${id}`,updateOrder)
                }
            } else if(state === "2") {
                swal("Đơn hàng đang đang được giao cho đơn vị chuyển phát, hãy liên lạc với chủ shop nếu bạn muốn hủy");
            } else if(state === "3") {
                swal("Đơn hàng đang được giao")
            } else if(state === "4") {
                swal("Đơn hàng đã được giao cho bạn")
            } else if(state === "5") {
                swal("Đơn đã bị hủy")
            }
        }
        function search(event) {
            let inputVal = event.target.parentNode.querySelector("input").value
            if(inputVal) {
                if(inputVal.trim()) {

                }
            }
        }
    </script>

</body>
</html>